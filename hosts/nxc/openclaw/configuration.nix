{ config, pkgs, modulesPath, inputs, outputs, ... }:

{
  imports = [
    # Autogenerated configuration specific to the iso, and not included in repo
    (modulesPath + "/virtualisation/proxmox-lxc.nix")
  ];

  environment.systemPackages = with pkgs; [
    git
    jq
  ];

  networking.hostName = "openclaw";

  # Create openclaw user
  users.users.openclaw = {
    isNormalUser = true;
    description = "Openclaw service user";
    home = "/home/openclaw";
    createHome = true;
  };

  services.openssh.enable = true;

  sops.secrets = {
    openclaw-telegram-token = {
      owner = "openclaw";
    };
    openclaw-anthropic-key = {
      owner = "openclaw";
    };
  };

  systemd.tmpfiles.rules = [
    "d /var/lib/openclaw 0755 root root -"
  ];

  home-manager.users.openclaw = { pkgs, lib, ... }: {
    home.stateVersion = "25.11";
    programs.home-manager.enable = true;

    programs.openclaw = {
      enable = true;
      documents = ./documents;

      instances.default = {
        enable = true;
        systemd.enable = true;

        config = {
          gateway = {
            mode = "local";
            auth = {
              token = "local-dev-token";  # For local mode, can be any value
            };
          };

          # Environment variables for API keys
          env.vars = {
            ANTHROPIC_API_KEY_FILE = config.sops.secrets.openclaw-anthropic-key.path;
          };

          # Telegram channel configuration
          channels.telegram = {
            tokenFile = config.sops.secrets.openclaw-telegram-token.path;
            allowFrom = [ 748642877 ];
            groups = {
              "*" = { requireMention = true; };
            };
          };
        };

        # Plugins can be added here after initial setup
        # To add plugins, you'll need to add them as flake inputs first
        plugins = [ ];
      };
    };

    # Load ANTHROPIC_API_KEY into the systemd service environment
    systemd.user.services.openclaw-gateway = {
      Service = {
        ExecStartPre = pkgs.writeShellScript "load-api-key" ''
          if [ -f "${config.sops.secrets.openclaw-anthropic-key.path}" ]; then
            export ANTHROPIC_API_KEY=$(cat "${config.sops.secrets.openclaw-anthropic-key.path}")
          fi
        '';
      };
    };
  };


  system.stateVersion = "25.11";
}
