{ config, pkgs, modulesPath, inputs, outputs, ... }:

{
  imports = [
    (modulesPath + "/virtualisation/proxmox-lxc.nix")
  ];

  # No extra packages needed - Frigate includes go2rtc

  networking.hostName = "frigate";

  services.openssh.enable = true;

  extra-services.tailscale = {
    enable = true;
    lxc = true;
  };
  extra-services.host-checkin.enable = true;

  systemd.tmpfiles.rules = [
    "d /mnt/media 0755 root root -"
    "d /var/lib/frigate/cache 0755 frigate frigate -"
    "d /var/lib/frigate/model_cache 0755 frigate frigate -"
    "d /media 0755 root root -"
    "L+ /media/frigate - - - - /var/lib/frigate"
  ];

  extra-services.mount_media.enable = true;

  # Configure SOPS secrets for Frigate
  sops.secrets.frigate-env = {
    owner = "frigate";
    group = "frigate";
    mode = "0400";
  };

  # Go2RTC service (standalone)
  services.go2rtc = {
    enable = true;
    settings = {
      streams = {
        front_door = [
          "rtsp://admin:{FRIGATE_CAMERA_PASSWORD}@192.168.10.54:554/cam/realmonitor?channel=1&subtype=0"
          "ffmpeg:front_door#audio=opus"
        ];
        back_door = [
          "rtsp://admin:{FRIGATE_CAMERA_PASSWORD}@192.168.10.53:554/cam/realmonitor?channel=1&subtype=0"
          "ffmpeg:back_door#audio=opus"
        ];
        bella_room = [
          "rtsp://admin:{FRIGATE_CAMERA_PASSWORD}@192.168.10.51:554/cam/realmonitor?channel=1&subtype=0"
          "ffmpeg:bella_room#audio=opus"
        ];
        girls_room = [
          "rtsp://admin:{FRIGATE_CAMERA_PASSWORD}@192.168.10.50:554/cam/realmonitor?channel=1&subtype=0"
          "ffmpeg:girls_room#audio=opus"
        ];
        nursery = [
          "rtsp://admin:{FRIGATE_CAMERA_PASSWORD}@192.168.10.52:554/cam/realmonitor?channel=1&subtype=0"
          "ffmpeg:nursery#audio=opus"
        ];
      };
      rtsp.listen = ":8554";
      webrtc.listen = ":8555";
      api.listen = ":1984";
    };
  };

  # Load secrets into go2rtc service and substitute environment variables
  systemd.services.go2rtc = {
    serviceConfig = {
      EnvironmentFile = config.sops.secrets.frigate-env.path;
      RuntimeDirectory = "go2rtc";
      ExecStartPre = pkgs.lib.mkForce "${pkgs.writeShellScript "go2rtc-subst-env" ''
        ${pkgs.envsubst}/bin/envsubst < ${config.environment.etc."go2rtc-template.yaml".source} > /run/go2rtc/config.yaml
      ''}";
      ExecStart = pkgs.lib.mkForce "${pkgs.go2rtc}/bin/go2rtc -config /run/go2rtc/config.yaml";
    };
  };

  # Create go2rtc config template for variable substitution
  environment.etc."go2rtc-template.yaml".text = ''
    api:
      listen: :1984
    rtsp:
      listen: :8554
    webrtc:
      listen: :8555
    streams:
      front_door:
        - rtsp://admin:$FRIGATE_CAMERA_PASSWORD@192.168.10.54:554/cam/realmonitor?channel=1&subtype=0
        - "ffmpeg:front_door#audio=opus"
      back_door:
        - rtsp://admin:$FRIGATE_CAMERA_PASSWORD@192.168.10.53:554/cam/realmonitor?channel=1&subtype=0
        - "ffmpeg:back_door#audio=opus"
      bella_room:
        - rtsp://admin:$FRIGATE_CAMERA_PASSWORD@192.168.10.51:554/cam/realmonitor?channel=1&subtype=0
        - "ffmpeg:bella_room#audio=opus"
      girls_room:
        - rtsp://admin:$FRIGATE_CAMERA_PASSWORD@192.168.10.50:554/cam/realmonitor?channel=1&subtype=0
        - "ffmpeg:girls_room#audio=opus"
      nursery:
        - rtsp://admin:$FRIGATE_CAMERA_PASSWORD@192.168.10.52:554/cam/realmonitor?channel=1&subtype=0
        - "ffmpeg:nursery#audio=opus"
  '';

  # Frigate NVR Configuration using custom module
  extra-services.frigate = {
    enable = true;

    # Use existing frigate-config.yml file
    configFile = ./frigate-config.yml;

    # Set environment file for secrets
    environmentFile = config.sops.secrets.frigate-env.path;

    # Set LIBVA driver for hardware acceleration
    environment = {
      LIBVA_DRIVER_NAME = "iHD";
    };

    # Enable automatic OpenVino setup and model download
    setupOpenVino = true;
  };

  # GPU access for LXC - match host device GIDs
  users.groups.renderaccess = {
    gid = 104;
    members = [ "frigate" ];
  };
  users.groups.videoaccess = {
    gid = 44;
    members = [ "frigate" ];
  };

  # Enable hardware graphics support
  hardware.graphics = {
    enable = true;
    extraPackages = with pkgs; [
      intel-media-driver
      intel-vaapi-driver
      libva-vdpau-driver
      vpl-gpu-rt
      intel-compute-runtime
      openvino
    ];
  };

  # Bind mount NFS recordings and exports to Frigate directories
  fileSystems."/var/lib/frigate/recordings" = {
    device = "/mnt/media/frigate/recordings";
    fsType = "none";
    options = [ "bind" ];
  };

  fileSystems."/var/lib/frigate/exports" = {
    device = "/mnt/media/frigate/exports";
    fsType = "none";
    options = [ "bind" ];
  };

  # Configure Intel GPU hardware acceleration and environment variable substitution
  systemd.services.frigate = {
    serviceConfig = {
      SupplementaryGroups = ["renderaccess" "videoaccess"];
      AmbientCapabilities = "CAP_PERFMON";

      # Create runtime directory for config
      RuntimeDirectory = "frigate";

      # Add environment variable substitution for config file
      ExecStartPre = pkgs.lib.mkBefore [
        (pkgs.writeShellScript "frigate-subst-env" ''
          # Load environment variables
          set -a
          source ${config.sops.secrets.frigate-env.path}
          set +a

          # Substitute {VAR} format variables in the config
          ${pkgs.gnused}/bin/sed \
            -e "s/{FRIGATE_MQTT_PASSWORD}/$FRIGATE_MQTT_PASSWORD/g" \
            -e "s/{FRIGATE_CAMERA_PASSWORD}/$FRIGATE_CAMERA_PASSWORD/g" \
            ${./frigate-config.yml} > ''${RUNTIME_DIRECTORY}/config.yml
        '')
      ];
    };

    # Override CONFIG_FILE to point to runtime substituted config (overrides mkDefault in module)
    environment.CONFIG_FILE = "/run/frigate/config.yml";

    # Ensure NFS mount is available before starting Frigate
    requires = [ "mnt-media.mount" ];
    after = [ "mnt-media.mount" ];
  };

  # Mount tmpfs for cache (reduces SSD wear)
  fileSystems."/var/lib/frigate/cache" = {
    device = "tmpfs";
    fsType = "tmpfs";
    options = [ "size=1G" "mode=0755" ];
  };

  # Configure nginx to listen on all interfaces for Frigate
  services.nginx.virtualHosts."frigate" = {
    listen = [
      { addr = "0.0.0.0"; port = 5000; }
      { addr = "[::]"; port = 5000; }
    ];
    # Add location to serve old /media/frigate paths from /var/lib/frigate
    locations."/media/frigate/" = {
      alias = "/var/lib/frigate/";
    };
  };

  # Open firewall ports for Frigate
  networking.firewall.allowedTCPPorts = [
    5000   # Web UI
    8554   # RTSP feeds
    8555   # WebRTC TCP
    1984   # Go2RTC
  ];
  networking.firewall.allowedUDPPorts = [
    8555   # WebRTC UDP
  ];

  system.stateVersion = "25.05";
}
