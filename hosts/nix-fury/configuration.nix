{ pkgs, config, modulesPath, inputs, outputs, ... }:

{
  imports = [
    # Autogenerated configuration specific to the iso, and not included in repo
    (modulesPath + "/virtualisation/proxmox-lxc.nix")
    ../../users/patrick/hosts/nix-fury
    # ../../secrets
  ];
	
  environment.systemPackages = with pkgs; [
		ansible
    # ansible-lint
    terraform
    sshpass
    lazygit

    # This is required for the ansibleguy.opnsense ansible role
    (python3.withPackages (ps: with ps; [
      httpx
    ]))
  ];

  sops.secrets."mollysocket-env" = {
    owner = "mollysocket";
    mode = "0400";
  };

  
  sops.secrets."mollysocket-vapid" = {
    owner = "mollysocket";
    mode = "0400";
  };

  extra-services.tailscale = {
    enable = true;
    lxc = true;
  };
  extra-services.host-checkin.enable = true;

  services.openssh.enable = true;

  # Enable virtualisation for containers
  virtualisation.podman = {
    enable = true;
    dockerCompat = true;
    defaultNetwork.settings.dns_enabled = true;
  };

  # Create necessary directories
  systemd.tmpfiles.rules = [
    "d /var/lib/myspeed 0755 root root -"
  ];

  virtualisation.oci-containers = {
    backend = "podman";
    containers = {
      myspeed = {
        image = "germannewsmaker/myspeed:latest";
        autoStart = true;
        ports = [
          "5216:5216"
        ];
        volumes = [
          "/var/lib/myspeed:/myspeed/data"
        ];
        extraOptions = [
          "--dns=1.1.1.1"
          "--dns=1.0.0.1"
        ];
      };
    };
  };

  services.gotify = {
    enable = true;
    package = inputs.nixpkgs-unstable.legacyPackages.${pkgs.stdenv.hostPlatform.system}.gotify-server;
    environment = {
      GOTIFY_SERVER_PORT = 8080;
    };
  };

  services.uptime-kuma = {
    enable = true;
    settings = {
      HOST = "0.0.0.0";
      PORT = "3001";
    };
  };

  services.mollysocket = {
    enable = true;
    settings = { 
      host = "0.0.0.0";
      port = 8020;
      allowed_endpoints = [ "https://drive.montycasa.com" ];
      # allowed_uuids = [ "*" ];
      vapid_key_file = config.sops.secrets.mollysocket-vapid.path;
      environmentFile = config.sops.secrets.mollysocket-env.path;
        # Contains MOLLY_ALLOWED_UUIDS
      # log_level = "info";
    };
  };

  users.users.mollysocket = {
    isNormalUser = true;
    description = "Molly Socket";
  };

  sops.secrets."proxmox-storage-monitoring-tokenSecret" = {
      owner = "root";
      mode = "0400";
  };
  sops.secrets."proxmox-storage-montoring-gotify-token" = {
      owner = "root";
      mode = "0400";
  };

  extra-services.proxmox-storage-monitor = {
    enable = true;
    
    proxmoxHosts = [
      {
        name = "stark";
        host = "stark";
        user = "root@pam";
        tokenId = "monitoring";
        tokenSecretFile = config.sops.secrets."proxmox-storage-monitoring-tokenSecret".path;
      }
      # {
      #   name = "starlord";
      #   host = "starlord";
      #   user = "root@pam";
      #   tokenId = "monitoring";
      #   tokenSecretFile = config.sops.secrets."proxmox-storage-monitoring-tokenSecret".path;
      # }
      # {
      #   name = "loki";
      #   host = "loki";
      #   user = "root@pam";
      #   tokenId = "monitoring";
      #   tokenSecretFile = config.sops.secrets."proxmox-storage-monitoring-tokenSecret".path;
      # }
    ];
    
    gotify = {
      url = "https://notify.montycasa.com";
      tokenFile = config.sops.secrets."proxmox-storage-montoring-gotify-token".path;
    };
    
    storageThreshold = 80;
    checkInterval = "hourly";
  };

  extra-services.simplex-relay = {
    enable = true;
    # Generate a random obscure hostname and set it here
    # For example: smp7a3f9e2b.montycasa.com
    # Run: echo "smp$(openssl rand -hex 4).montycasa.com" to generate
    host = "smp28.montycasa.com";  # Set this to your obscure hostname after generating
    port = 5223;
    # Don't open public firewall - only accessible via Tailscale from bifrost
    openFirewall = false;
  };

  networking.firewall.allowedTCPPorts = [ 8080 3001 5216 ];

  system.stateVersion = "24.05";
}
